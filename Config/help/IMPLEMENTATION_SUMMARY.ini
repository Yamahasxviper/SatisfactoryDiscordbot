; ===========================================================================================
; IMPLEMENTATION SUMMARY - Discord Chat Bridge
; ===========================================================================================
; High-level overview of the code implementation
; ===========================================================================================

[Overview]
Title=Implementation Summary
Purpose=High-level code structure and flow
Audience=Developers and technical users

; ===========================================================================================
; FILE STRUCTURE
; ===========================================================================================

[FileStructure_Plugin]
PluginDescriptor=DiscordChatBridge.uplugin
Purpose=Defines plugin metadata and dependencies
KeyFields=RequiredOnRemote: false, Modules, Plugins

[FileStructure_Config]
DefaultConfig=Config/DiscordChatBridge.ini
UnifiedLocation=Single config file for all platforms
LegacyLocations=Config/WindowsServer/, Config/LinuxServer/ (still supported)
Section=/Script/DiscordChatBridge.DiscordChatSubsystem

[FileStructure_Source]
Directory=Source/DiscordChatBridge/
Subdirectories=Public/, Private/
BuildScript=DiscordChatBridge.Build.cs
ModuleClass=DiscordChatBridgeModule

[FileStructure_PublicHeaders]
DiscordChatBridgeModule.h=Module initialization
DiscordChatSubsystem.h=Main subsystem controller
DiscordAPI.h=Discord REST API wrapper
DiscordGateway.h=Discord WebSocket Gateway client
DiscordChatGameInstanceModule.h=Game instance module integration

[FileStructure_PrivateImplementation]
DiscordChatBridgeModule.cpp=Module startup/shutdown
DiscordChatSubsystem.cpp=Subsystem logic and event handling
DiscordAPI.cpp=HTTP communication with Discord
DiscordGateway.cpp=WebSocket connection management
DiscordChatGameInstanceModule.cpp=Game instance integration

; ===========================================================================================
; CORE COMPONENTS
; ===========================================================================================

[Component_DiscordChatSubsystem]
Type=AModSubsystem (Actor)
Role=Main controller and coordinator
Responsibilities=Initialize API, handle events, coordinate message flow
Spawning=Server only (SpawnOnServer policy)
Lifetime=Exists while server running

[Component_DiscordAPI]
Type=UObject
Role=Discord REST API client
Responsibilities=HTTP requests, polling, message sending
Operations=Send message, get messages, send notifications, update status
Protocol=Discord API v10 (REST)

[Component_DiscordGateway]
Type=UObject
Role=Discord Gateway WebSocket client
Responsibilities=Persistent connection, presence updates, real-time events
Operations=Connect, send heartbeat, update presence, handle events
Protocol=Discord Gateway API v10 (WebSocket)
Optional=Yes, requires WebSockets plugin

[Component_ChatManager]
Type=AFGChatManager (Game System)
Role=In-game chat manager
Source=Base Satisfactory game
Integration=Subsystem binds to OnChatMessageAdded event

; ===========================================================================================
; INITIALIZATION FLOW
; ===========================================================================================

[Init_Step1_ModuleLoad]
Phase=Module Loading
Action=FDiscordChatBridgeModule::StartupModule() called
Timing=Engine startup
Logging=DiscordChatBridge: Module Started

[Init_Step2_SubsystemSpawn]
Phase=Subsystem Spawning
Action=ADiscordChatSubsystem spawned by SML
Trigger=World initialization on server
Replication=SpawnOnServer policy ensures server-only spawn

[Init_Step3_ConfigLoad]
Phase=Configuration Loading
Function=ADiscordChatSubsystem::LoadConfiguration()
Sources=Config TXT file or INI files
Fallback=TXT first, then INI if TXT not found
Validation=Check BotToken and ChannelId present

[Init_Step4_APICreate]
Phase=API Initialization
Function=NewObject<UDiscordAPI>(this)
Action=Create Discord API wrapper object
Configuration=Pass BotConfig to Initialize()

[Init_Step5_BeginPlay]
Phase=Begin Play
Function=ADiscordChatSubsystem::BeginPlay()
Check=Verify World pointer and API initialized
Early_Exit=If not configured, skip initialization

[Init_Step6_ChatBinding]
Phase=Chat Manager Binding
Action=ChatManager->OnChatMessageAdded.AddDynamic()
Event=Bind to game chat events
Purpose=Receive notifications when players chat

[Init_Step7_StartPolling]
Phase=Start Discord Polling
Action=DiscordAPI->StartPolling()
Timer=Set up timer for periodic Discord API polling
Interval=Configurable via PollIntervalSeconds

[Init_Step8_Notifications]
Phase=Server Notifications
Condition=If EnableServerNotifications=true
Action=Send server start notification to Discord
Message=Configurable via ServerStartMessage

[Init_Step9_Activity]
Phase=Bot Activity Setup
Condition=If EnableBotActivity=true
Timer=Set up activity update timer
Interval=Configurable via ActivityUpdateIntervalSeconds
Gateway=Connect via WebSocket if UseGatewayForPresence=true

; ===========================================================================================
; MESSAGE FLOW - DISCORD TO GAME
; ===========================================================================================

[DiscordToGame_Step1_Poll]
Phase=Polling
Action=DiscordAPI polls Discord REST API
Timer=Periodic timer fires (PollIntervalSeconds)
Request=GET /channels/{channelId}/messages

[DiscordToGame_Step2_Parse]
Phase=Message Parsing
Action=DiscordAPI parses JSON response
Filter=Ignore bot's own messages (prevent loops)
Track=Update LastProcessedMessageIndex

[DiscordToGame_Step3_Callback]
Phase=Callback
Action=DiscordAPI calls OnMessageReceived delegate
Data=Username, message content, message ID
Handler=ADiscordChatSubsystem::OnDiscordMessageReceived()

[DiscordToGame_Step4_Format]
Phase=Message Formatting
Action=Apply DiscordNameFormat template
Placeholders={source} replaced with DiscordSourceLabel, {username} with Discord username
Example=[Discord] JohnDoe: Hello

[DiscordToGame_Step5_Send]
Phase=Send to Game
Action=Call ChatManager to broadcast message
Method=AFGChatManager chat system
Visibility=All connected players receive message

; ===========================================================================================
; MESSAGE FLOW - GAME TO DISCORD
; ===========================================================================================

[GameToDiscord_Step1_Event]
Phase=Chat Event
Action=Player types message in game
Event=AFGChatManager fires OnChatMessageAdded
Binding=Subsystem receives callback

[GameToDiscord_Step2_Retrieve]
Phase=Message Retrieval
Action=Get latest chat message from ChatManager
Filter=Ignore messages from Discord (check for [Discord] prefix)
Data=Player name, message content

[GameToDiscord_Step3_Format]
Phase=Message Formatting
Action=Apply GameNameFormat template
Placeholders={username} replaced with player name, {message} with content
Example=**[Steve]** Found iron deposit

[GameToDiscord_Step4_Send]
Phase=Send to Discord
Action=Call DiscordAPI->SendMessage()
Request=POST /channels/{channelId}/messages
JSON={"content": formatted message}

[GameToDiscord_Step5_Confirm]
Phase=Confirmation
Action=Handle HTTP response
Success=Message sent successfully
Error=Log error if send fails

; ===========================================================================================
; CONFIGURATION SYSTEM
; ===========================================================================================

[Config_LoadOrder]
Priority1=Mods/DiscordChatBridge/config/DiscordChatBridge.txt (if exists)
Priority2=Config/DiscordChatBridge.ini (unified location)
Priority3=Config/[Platform]Server/DiscordChatBridge.ini (legacy)
Fallback=If TXT not found, try INI system

[Config_TXTFormat]
Format=KEY=VALUE
Parser=FServerDefaultsConfigLoader::LoadFromServerDefaults()
Benefits=Simple format, automatic SML persistence
Example=BotToken=YOUR_TOKEN_HERE

[Config_INIFormat]
Format=INI sections and keys
Parser=GConfig->GetString/GetBool/GetFloat()
Section=/Script/DiscordChatBridge.DiscordChatSubsystem
Legacy=Traditional Unreal Engine config system

[Config_Validation]
Required=BotToken and ChannelId
Optional=All other settings have defaults
Behavior=If required settings missing, mod loads but inactive
Logging=Clear warnings displayed in server logs

; ===========================================================================================
; DISCORD API OPERATIONS
; ===========================================================================================

[API_SendMessage]
Method=POST
Endpoint=/channels/{channelId}/messages
Headers=Authorization: Bot {token}, Content-Type: application/json
Body={"content": "message text"}
RateLimit=5 messages per 5 seconds per channel

[API_GetMessages]
Method=GET
Endpoint=/channels/{channelId}/messages
Headers=Authorization: Bot {token}
Query=?limit=100
Purpose=Poll for new messages

[API_SendNotification]
Method=POST
Endpoint=/channels/{notificationChannelId}/messages
Purpose=Server start/stop notifications
Condition=EnableServerNotifications=true

[API_UpdateActivity]
Method=POST (REST) or WebSocket (Gateway)
Endpoint_REST=/channels/{activityChannelId}/messages
Endpoint_Gateway=WebSocket PRESENCE_UPDATE opcode
Purpose=Update player count status

; ===========================================================================================
; DISCORD GATEWAY (WEBSOCKET)
; ===========================================================================================

[Gateway_Connection]
Protocol=WSS (WebSocket Secure)
Endpoint=wss://gateway.discord.gg
Port=443
Lifecycle=Connect, identify, heartbeat, disconnect

[Gateway_Operations]
OpCode_0=Dispatch (receive events)
OpCode_1=Heartbeat (keep alive)
OpCode_2=Identify (authenticate)
OpCode_10=Hello (receive heartbeat interval)
OpCode_3=Presence Update (set bot status)

[Gateway_Presence]
Feature=Bot Presence Status
Display=Shows "Playing with X players" in member list
Update=Sent via OpCode 3 (PRESENCE_UPDATE)
Format=Configurable via GatewayPresenceFormat
ActivityType=Configurable (Playing, Watching, etc.)

[Gateway_Heartbeat]
Purpose=Keep connection alive
Interval=Received from server (typically ~40 seconds)
Method=Send OpCode 1 periodically
Timeout=If no ACK received, reconnect

; ===========================================================================================
; ERROR HANDLING
; ===========================================================================================

[ErrorHandling_Configuration]
MissingConfig=Mod loads but remains inactive
Logging=Clear warnings with instructions
NoFailure=Server starts successfully

[ErrorHandling_APIFailures]
HTTP_401=Invalid bot token
HTTP_403=Missing permissions
HTTP_404=Invalid channel ID
HTTP_429=Rate limit exceeded
Retry=Automatic retry with backoff for transient errors

[ErrorHandling_NetworkFailures]
Timeout=HTTP request timeout
NoConnection=Server has no internet
DNS=Cannot resolve Discord API domain
Retry=Automatic retry for transient failures

[ErrorHandling_GatewayFailures]
ConnectionLost=WebSocket disconnected
InvalidSession=Session expired
Reconnect=Automatic reconnection with exponential backoff
Fallback=Can fallback to REST-only mode

; ===========================================================================================
; TESTING AND DEBUGGING
; ===========================================================================================

[Testing_LogMessages]
LogCategory=LogTemp
Prefix=DiscordChatBridge:, DiscordChatSubsystem:, DiscordAPI:, DiscordGateway:
Verbosity=Log, Warning, Error
Location=Server console and log files

[Testing_ConfigurationTest]
Test=Set BotToken and ChannelId
Expected=See "Successfully initialized" in logs
Verify=Check Discord API: Started polling for messages

[Testing_MessageFlow]
Test1=Type in Discord, see in game
Test2=Type in game, see in Discord
Verify=Both directions work
Check=Look for message formatting

[Debugging_CommonIssues]
Issue1=Messages not appearing - Check bot token and channel ID
Issue2=Bot offline - Check network connectivity
Issue3=Permission errors - Verify bot permissions in Discord
Issue4=Rate limits - Reduce polling frequency

; ===========================================================================================
; PERFORMANCE CONSIDERATIONS
; ===========================================================================================

[Performance_Polling]
Method=Timer-based polling
Frequency=Configurable (default 2 seconds)
Impact=Minimal, single HTTP request per interval
Optimization=LastProcessedMessageIndex prevents duplicate processing

[Performance_MessageSending]
Method=Asynchronous HTTP requests
Blocking=Non-blocking, uses Unreal's async HTTP
Impact=Negligible on game performance
Batching=Not implemented (messages sent as received)

[Performance_Gateway]
Connection=Persistent WebSocket
Overhead=One connection, periodic heartbeats
Memory=Minimal, buffers for incoming messages
Threads=Handled by Unreal's WebSocket implementation

[Performance_Replication]
Subsystem=Not replicated to clients
ChatMessages=Uses existing game chat replication
Additional=No additional network traffic to clients

; ===========================================================================================
; ADDITIONAL RESOURCES
; ===========================================================================================

[Resources]
TechnicalArchitecture=See TECHNICAL_ARCHITECTURE.ini for architectural details
Dependencies=See DEPENDENCY_EXPLANATION.ini for WebSockets info
SetupGuide=See SETUP_GUIDE.ini for configuration
Examples=See EXAMPLES.ini for configuration examples
CompilationFix=See COMPILATION_FIX.ini for build issues
